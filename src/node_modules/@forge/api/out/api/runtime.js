"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.wrapInMetrics = exports.getRuntime = void 0;
const errors_1 = require("./errors");
const node_fetch_1 = require("node-fetch");
function getRuntime() {
    const runtime = global.__forge_runtime__;
    if (!runtime) {
        throw new Error('Forge runtime not found.');
    }
    return runtime;
}
exports.getRuntime = getRuntime;
function wrapInMetrics(name, fn, { tags } = {}) {
    return async (...args) => {
        const { metrics } = getRuntime();
        metrics.counter(name, tags).incr();
        const timer = metrics.timing(name, tags).measure();
        let success = true;
        try {
            return await fn(...args);
        }
        catch (e) {
            if (e instanceof errors_1.ProxyRequestError || e instanceof node_fetch_1.FetchError) {
                success = false;
            }
            throw e;
        }
        finally {
            timer.stop({ success: success.toString() });
        }
    };
}
exports.wrapInMetrics = wrapInMetrics;
